{% extends "base.html" %}

{% block title %}{{ 'Editar' if entregador else 'Novo' }} Entregador - Sistema{% endblock %}

{% block header %}{{ 'Editar' if entregador else 'Novo' }} Entregador{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/entregadores/entregadores.css') }}">
<style>
    /* ===== STEPPER/WIZARD ===== */
    .wizard-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 30px;
    }

    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }

    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e0e0e0;
        z-index: 0;
    }

    .wizard-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: bold;
        transition: all 0.3s;
    }

    .wizard-step.active .step-number {
        background: #3498db;
        color: white;
    }

    .wizard-step.completed .step-number {
        background: #2ecc71;
        color: white;
    }

    .step-title {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }

    .wizard-step.active .step-title {
        color: #3498db;
        font-weight: 600;
    }

    .wizard-step.completed .step-title {
        color: #2ecc71;
    }

    .auto-pix-status {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: #8e9bae;
        transition: color 0.2s ease;
    }

    .auto-pix-status.loading {
        color: #0b5cff;
    }

    .auto-pix-status.success {
        color: #0f9d58;
    }

    .auto-pix-status.error {
        color: #d93025;
    }

    .wizard-content {
        min-height: 400px;
    }

    .wizard-panel {
        display: none;
    }

    .wizard-panel.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .wizard-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .btn-wizard {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }

    .btn-wizard-prev {
        background: #f5f5f5;
        color: #666;
    }

    .btn-wizard-prev:hover {
        background: #e0e0e0;
    }

    .btn-wizard-next {
        background: #3498db;
        color: white;
    }

    .btn-wizard-next:hover {
        background: #2980b9;
    }

    .btn-wizard-submit {
        background: #2ecc71;
        color: white;
    }

    .btn-wizard-submit:hover {
        background: #27ae60;
    }

    .wizard-actions .btn-wizard-prev {
        visibility: hidden;
    }

    .wizard-actions.step-2 .btn-wizard-prev,
    .wizard-actions.step-3 .btn-wizard-prev {
        visibility: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {{ 'error' if category == 'error' else 'success' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="formEntregador">
        <div class="wizard-container">
            <!-- Indicadores de Etapas -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Dados Pessoais</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Localização</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Financeiro</div>
                </div>
            </div>

            <!-- Conteúdo das Etapas -->
            <div class="wizard-content">
                <!-- ETAPA 1: Dados Pessoais -->
                <div class="wizard-panel active" data-panel="1">
                    <h3 style="margin-bottom: 25px; color: #333;">Dados Pessoais</h3>
                    
                    <div class="form-group">
                        <label for="recebedor" class="form-label required">Nome Completo</label>
                        <input type="text" 
                               id="recebedor" 
                               name="recebedor" 
                               class="form-input"
                               value="{% if entregador and entregador.recebedor %}{{ entregador.recebedor }}{% elif dados_preenchidos and dados_preenchidos.recebedor %}{{ dados_preenchidos.recebedor }}{% endif %}"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="id_da_pessoa_entregadora" class="form-label required">ID do Entregador (UUID do iFood)</label>
                        <input type="text" 
                               id="id_da_pessoa_entregadora" 
                               name="id_da_pessoa_entregadora" 
                               class="form-input"
                               value="{% if entregador and entregador.id_da_pessoa_entregadora %}{{ entregador.id_da_pessoa_entregadora }}{% elif dados_preenchidos and dados_preenchidos.id_da_pessoa_entregadora %}{{ dados_preenchidos.id_da_pessoa_entregadora }}{% endif %}"
                               {% if entregador and entregador.id_da_pessoa_entregadora and not (is_novo_pix is defined and is_novo_pix) %}
                                   readonly
                               {% else %}
                                   required
                               {% endif %}>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">ID único do entregador no iFood (obrigatório para novos cadastros)</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" 
                                   id="cpf" 
                                   name="cpf" 
                                   class="form-input"
                                   value="{{ entregador.cpf if entregador else '' }}"
                                   placeholder="000.000.000-00">
                            <small id="autoPixStatus" class="auto-pix-status">
                                Informe o CPF para tentarmos preencher automaticamente os dados bancários.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   class="form-input"
                                   value="{{ entregador.email if entregador else '' }}"
                                   placeholder="email@exemplo.com">
                        </div>
                    </div>
                </div>

                <!-- ETAPA 2: Localização -->
                <div class="wizard-panel" data-panel="2">
                    <h3 style="margin-bottom: 25px; color: #333;">Localização</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="praca" class="form-label required">Praça</label>
                            <select id="praca" name="praca" class="form-select" required>
                                <option value="">Selecione a praça...</option>
                                <option value="Rio Barra" {% if entregador and entregador.praca == 'Rio Barra' %}selected{% endif %}>Rio Barra</option>
                                <option value="Rio Zona Sul" {% if entregador and entregador.praca == 'Rio Zona Sul' %}selected{% endif %}>Rio Zona Sul</option>
                                <option value="Rio Campo Grande & Santa Cruz" {% if entregador and entregador.praca == 'Rio Campo Grande & Santa Cruz' %}selected{% endif %}>Rio Campo Grande & Santa Cruz</option>
                                <option value="Rio Madureira" {% if entregador and entregador.praca == 'Rio Madureira' %}selected{% endif %}>Rio Madureira</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="subpraca" class="form-label">Sub-Praça</label>
                            <select id="subpraca" name="subpraca" class="form-select">
                                <option value="">Selecione a sub-praça...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ETAPA 3: Financeiro -->
                <div class="wizard-panel" data-panel="3">
                    <h3 style="margin-bottom: 25px; color: #333;">Dados Financeiros</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="emissor" class="form-label required">Emissor</label>
                            <select id="emissor" name="emissor" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Dues" {% if entregador and entregador.emissor == 'Dues' %}selected{% endif %}>Dues</option>
                                <option value="Proprio" {% if entregador and entregador.emissor == 'Proprio' %}selected{% endif %}>Próprio</option>
                                <option value="Outros" {% if entregador and entregador.emissor == 'Outros' %}selected{% endif %}>Outros</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status" class="form-label required">Status</label>
                            <select id="status" name="status" class="form-select" required>
                                <option value="Ativo" {% if not entregador or entregador.status == 'Ativo' %}selected{% endif %}>Ativo</option>
                                <option value="Inativo" {% if entregador and entregador.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipo_de_chave_pix" class="form-label required">Tipo de Chave PIX</label>
                            <select id="tipo_de_chave_pix" name="tipo_de_chave_pix" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="CNPJ" {% if entregador and entregador.tipo_de_chave_pix == 'CNPJ' %}selected{% endif %}>CNPJ</option>
                                <option value="Telefone" {% if entregador and entregador.tipo_de_chave_pix == 'Telefone' %}selected{% endif %}>Telefone</option>
                                <option value="Email" {% if entregador and entregador.tipo_de_chave_pix == 'Email' %}selected{% endif %}>Email</option>
                                <option value="Chave Aleatória" {% if entregador and entregador.tipo_de_chave_pix == 'Chave Aleatória' %}selected{% endif %}>Chave Aleatória</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="chave_pix" class="form-label required">Chave PIX</label>
                            <input type="text" 
                                   id="chave_pix" 
                                   name="chave_pix" 
                                   class="form-input"
                                   value="{{ entregador.chave_pix if entregador else '' }}"
                                   required
                                   placeholder="Chave PIX do entregador">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cnpj" class="form-label required">CNPJ</label>
                        <input type="text" 
                               id="cnpj" 
                               name="cnpj" 
                               class="form-input"
                               value="{{ entregador.cnpj if entregador else '' }}"
                               required
                               placeholder="00.000.000/0000-00">
                    </div>
                </div>
            </div>

            <!-- Botões de Navegação -->
            <div class="wizard-actions step-1">
                <button type="button" class="btn-wizard btn-wizard-prev" onclick="previousStep()">Anterior</button>
                <div>
                    <button type="button" class="btn-wizard btn-wizard-next" onclick="nextStep()">Próximo</button>
                    <button type="submit" class="btn-wizard btn-wizard-submit" id="btnSubmit" style="display: none;">{{ 'Atualizar' if entregador else 'Cadastrar' }} Entregador</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Mapeamento de praças para subpraças
    const subpracasPorPraca = {
        'Rio Barra': ['Barra Centro', 'Recreio', 'Taquara', 'Jacarepaguá', 'Freguesia'],
        'Rio Zona Sul': ['Centro ZS', 'Ipanema', 'Copacabana', 'Botafogo', 'Vila Isabel', 'São Cristóvão'],
        'Rio Campo Grande & Santa Cruz': ['Centro CG', 'Monteiro', 'Santa Cruz'],
        'Rio Madureira': ['Penha', 'Irajá', 'Rocha Miranda', 'Realengo']
    };

    const mapaPracasFormulario = {
        'rio barra': 'Rio Barra',
        'barra': 'Rio Barra',
        'rio zona sul': 'Rio Zona Sul',
        'zona sul': 'Rio Zona Sul',
        'rio campo grande': 'Rio Campo Grande & Santa Cruz',
        'rio campo grande & santa cruz': 'Rio Campo Grande & Santa Cruz',
        'campo grande': 'Rio Campo Grande & Santa Cruz',
        'rio madureira': 'Rio Madureira',
        'madureira': 'Rio Madureira'
    };

    const pracaAtual = '{{ entregador.praca if entregador and entregador.praca else '' }}';
    const subpracaAtual = '{{ entregador.subpraca if entregador and entregador.subpraca else '' }}';

    const pracaSelect = document.getElementById('praca');
    const subpracaSelect = document.getElementById('subpraca');
    const tipoChavePix = document.getElementById('tipo_de_chave_pix');
    const chavePixInput = document.getElementById('chave_pix');
    const cpfInput = document.getElementById('cpf');
    const autoPixStatus = document.getElementById('autoPixStatus');
    const recebedorInput = document.getElementById('recebedor');

    let currentStep = 1;
    const totalSteps = 3;
    let ultimoCpfConsultado = '';
    let dadosPixEncontrados = null;
    let buscandoDadosPix = false;

    function atualizarStatusAutoPix(texto, tipo = '') {
        if (!autoPixStatus) return;
        autoPixStatus.textContent = texto;
        autoPixStatus.classList.remove('loading', 'success', 'error');
        if (tipo) {
            autoPixStatus.classList.add(tipo);
        }
    }

    function atualizarSubpracas(selectedValue = null) {
        if (!pracaSelect || !subpracaSelect) return;

        const pracaSelecionada = pracaSelect.value;
        const previousValue = subpracaSelect.value;
        subpracaSelect.innerHTML = '<option value="">Selecione a sub-praça...</option>';

        if (pracaSelecionada && subpracasPorPraca[pracaSelecionada]) {
            const targetValue = selectedValue !== null ? selectedValue : previousValue;
            subpracasPorPraca[pracaSelecionada].forEach(function(subpraca) {
                const option = document.createElement('option');
                option.value = subpraca;
                option.textContent = subpraca;
                if (targetValue && targetValue === subpraca) {
                    option.selected = true;
                }
                subpracaSelect.appendChild(option);
            });
        }
    }

    function mapPracaFormulario(valor) {
        if (!valor) return '';
        const chave = valor.toLowerCase().trim();
        return mapaPracasFormulario[chave] || '';
    }

    function setSelectValueIfExists(selectEl, value) {
        if (!selectEl || !value) return false;
        const option = Array.from(selectEl.options).find(
            opt => opt.value.toLowerCase() === value.toLowerCase()
        );
        if (option) {
            selectEl.value = option.value;
            return true;
        }
        return false;
    }

    function preencherCamposPix(data) {
        if (!data) return;

        if (data.nome && recebedorInput && !recebedorInput.value.trim()) {
            recebedorInput.value = data.nome;
        }

        // Preencher e-mail
        const emailInput = document.getElementById('email');
        if (data.email && emailInput && !emailInput.value.trim()) {
            emailInput.value = data.email;
        }

        // Preencher CNPJ
        const cnpjInput = document.getElementById('cnpj');
        if (data.cnpj && cnpjInput && !cnpjInput.value.trim()) {
            cnpjInput.value = data.cnpj;
        }

        const pracaNormalizada = mapPracaFormulario(data.praca);
        const subpracaFormulario = data.subpraca || null;
        if (pracaNormalizada && pracaSelect) {
            setSelectValueIfExists(pracaSelect, pracaNormalizada);
            atualizarSubpracas(subpracaFormulario);
        } else {
            atualizarSubpracas();
        }

        if (subpracaFormulario) {
            setSelectValueIfExists(subpracaSelect, subpracaFormulario);
        }

        if (data.tipo_de_chave_pix && tipoChavePix) {
            setSelectValueIfExists(tipoChavePix, data.tipo_de_chave_pix);
        }

        if (data.chave_pix && chavePixInput) {
            chavePixInput.value = data.chave_pix;
        }
    }

    async function tentarAutoPreencherPorCpf(force = false) {
        if (!cpfInput) return;
        const cpfValor = cpfInput.value.trim();

        if (!cpfValor) {
            ultimoCpfConsultado = '';
            atualizarStatusAutoPix('Informe o CPF para tentarmos preencher automaticamente os dados bancários.', '');
            return;
        }

        if (!force && cpfValor === ultimoCpfConsultado && dadosPixEncontrados) {
            return;
        }

        ultimoCpfConsultado = cpfValor;
        buscandoDadosPix = true;
        atualizarStatusAutoPix('Buscando dados bancários...', 'loading');

        try {
            const response = await fetch(`/api/bancario/dados?cpf=${encodeURIComponent(cpfValor)}`);
            const payload = await response.json().catch(() => ({}));

            if (!response.ok || !payload.success || !payload.data) {
                throw new Error(payload.message || 'Não encontramos dados bancários com este CPF.');
            }

            dadosPixEncontrados = payload.data;
            preencherCamposPix(payload.data);
            atualizarStatusAutoPix('Dados bancários encontrados e aplicados automaticamente.', 'success');
        } catch (error) {
            dadosPixEncontrados = null;
            atualizarStatusAutoPix(
                error.message || 'Não encontramos dados bancários com este CPF.',
                'error'
            );
        } finally {
            buscandoDadosPix = false;
        }
    }

    if (pracaSelect) {
        pracaSelect.addEventListener('change', () => atualizarSubpracas());
        if (pracaSelect.value || pracaAtual) {
            if (!pracaSelect.value && pracaAtual) {
                pracaSelect.value = pracaAtual;
            }
            atualizarSubpracas(subpracaAtual);
        }
    }

    if (tipoChavePix && chavePixInput) {
        const placeholders = {
            'CNPJ': '00.000.000/0000-00',
            'Telefone': '(00) 00000-0000',
            'Email': 'email@exemplo.com',
            'Chave Aleatória': 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
        };
        tipoChavePix.addEventListener('change', function() {
            chavePixInput.placeholder = placeholders[this.value] || 'Chave PIX do entregador';
        });
    }

    if (cpfInput) {
        let debounceTimeout;

        const dispararBuscaCPF = () => {
            if (!buscandoDadosPix) {
                tentarAutoPreencherPorCpf();
            }
        };

        cpfInput.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            const valor = cpfInput.value.trim();

            if (!valor) {
                dadosPixEncontrados = null;
                ultimoCpfConsultado = '';
                atualizarStatusAutoPix('Informe o CPF para tentarmos preencher automaticamente os dados bancários.');
                return;
            }

            debounceTimeout = setTimeout(dispararBuscaCPF, 800);
        });

        cpfInput.addEventListener('blur', dispararBuscaCPF);
    }

    {% if entregador %}
        currentStep = 3;
    {% endif %}
    updateWizard();

    function validateStep(step) {
        const panel = document.querySelector(`.wizard-panel[data-panel="${step}"]`);
        if (!panel) return true;
        const requiredFields = panel.querySelectorAll('[required]');
        
        for (let field of requiredFields) {
            if (!field.value.trim()) {
                field.focus();
                alert(`Por favor, preencha o campo: ${field.previousElementSibling.textContent.replace('*', '').trim()}`);
                return false;
            }
        }
        return true;
    }

    async function nextStep() {
        if (!validateStep(currentStep)) {
            return;
        }
        
        if (currentStep < totalSteps) {
            currentStep++;
            if (currentStep === 2 || currentStep === 3) {
                await tentarAutoPreencherPorCpf(currentStep === 3);
            }
            updateWizard();
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            currentStep--;
            updateWizard();
        }
    }

    function updateWizard() {
        document.querySelectorAll('.wizard-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        const painelAtual = document.querySelector(`.wizard-panel[data-panel="${currentStep}"]`);
        if (painelAtual) {
            painelAtual.classList.add('active');
        }

        document.querySelectorAll('.wizard-step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            const stepNum = index + 1;
            if (stepNum < currentStep) {
                step.classList.add('completed');
            } else if (stepNum === currentStep) {
                step.classList.add('active');
            }
        });

        const actions = document.querySelector('.wizard-actions');
        if (actions) {
            actions.className = `wizard-actions step-${currentStep}`;
        }
        
        const btnNext = document.querySelector('.btn-wizard-next');
        const btnSubmit = document.getElementById('btnSubmit');
        
        if (btnNext && btnSubmit) {
            if (currentStep === totalSteps) {
                btnNext.style.display = 'none';
                btnSubmit.style.display = 'inline-block';
            } else {
                btnNext.style.display = 'inline-block';
                btnSubmit.style.display = 'none';
            }
        }
    }

    // ===== SUPORTE PARA TECLA ENTER =====
    // Adicionar listener para Enter em todos os campos de input do formulário
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            // Capturar Enter em todos os inputs e selects
            form.addEventListener('keydown', function(e) {
                // Se pressionou Enter
                if (e.key === 'Enter' || e.keyCode === 13) {
                    // Não fazer nada se for textarea
                    if (e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    // Prevenir submit padrão do formulário
                    e.preventDefault();
                    
                    // Se estiver no último passo, submeter o formulário
                    if (currentStep === totalSteps) {
                        const btnSubmit = document.getElementById('btnSubmit');
                        if (btnSubmit) {
                            btnSubmit.click();
                        }
                    } else {
                        // Caso contrário, avançar para próximo passo
                        nextStep();
                    }
                }
            });
        }
    });
</script>
{% endblock %}
